<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>编辑报表 - Mini-Report</title>
    <link rel="stylesheet" href="themes/default/easyui.css">
    <link rel="stylesheet" href="themes/icon.css">
    <style type="text/css">
    table.report-form th {
        font-weight: normal;
        text-align: right;
    }
    table.report-form td {
        padding: 5px 0;
    }
    table.report-form th.align-top {
        vertical-align: top;
        padding-top: 8px;
    }
    span.form-tip {
        color: gray;
    }
    ul.field-list {
        margin: 0;
        padding: 0;
        list-style: none;
    }
    ul.field-list li {
        margin: 0;
        padding: 0;
    }
    ul.field-list a {
        display: block;
        padding: 3px 5px;
        text-decoration: none;
        color: black;
    }
    ul.field-list a:hover {
        background-color: #ddd;
    }
    .mini-textbox {
        border: 1px solid #95B8E7;
        height: 18px;
        line-height: 20px;
        font-size: 12px;
    }
    .mini-checkbox {
        vertical-align: middle;
    }
    .mini-radio {
        vertical-align: text-bottom;
    }
    .mini-multiselect {
        border: 1px solid #95B8E7;
    }
    </style>
  </head>
  <body>
    <h3>编辑报表</h3>

    <div class="easyui-tabs" data-options="tabPosition:'left'" style="width: 768px; height: 500px;">
      <div title="基本信息" style="padding: 10px;">
      <table class="report-form">
        <tr>
          <th>报表名称：</th>
          <td><input type="text" value="分销每日数据" class="mini-textbox"></td>
        </tr>
        <tr>
          <th>状态：</th>
          <td>
            <label><input type="radio" name="status" checked="checked" class="mini-radio"> 草稿</label>
            <label><input type="radio" name="status" class="mini-radio"> 有效</label>
            <label><input type="radio" name="status" class="mini-radio"> 暂停</label>
          </td>
        </tr>
        <tr>
          <th>创建人：</th>
          <td>
            <select class="easyui-combobox" style="width: 80px;">
              <option>郑浩</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>运行时间：</th>
          <td>
            <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
              <option>每天</option>
              <option>每周</option>
            </select>
            <input type="text" value="09:00" class="mini-textbox">
          </td>
        </tr>
        <tr>
          <th>邮件标题：</th>
          <td>
            <input type="text" value="分销每日数据 ${date}" class="mini-textbox">
            <span class="form-tip">示例：分销每日数据 2013-09-08</span>
          </td>
        </tr>
        <tr>
          <th class="align-top">收件人：</th>
          <td>
            <div>
            <select multiple="multiple" style="float: left; margin: 0 10px 10px 0;" class="mini-multiselect">
              <option>dl-data-au@anjuke.com</option>
              <option>dl-data-bu@anjuke.com</option>
            </select>
            <a href="#" class="easyui-linkbutton">删除</a>
            </div>
            <div style="clear: both;">
            <input type="text" value="haozheng@anjuke.com" style="margin-right: 10px;" class="mini-textbox">
            <a href="#" class="easyui-linkbutton">添加</a>
            </div>
          </td>
        </tr>
      </table>
      </div>

      <div title="存储过程">
        <div id="editor" style="height: 450px;">
drop table if exists tommy_oto_coor_comm_temp;
create table tommy_oto_coor_comm_temp as
select DATE_SUB(CURDATE(),INTERVAL 1 day) log_dt,
       fx_id,
       comm_id
 from dw_db.dw_nh_fx_info
where fx_status = 1 and is_display = 0;


drop table if exists tommy_oto_ppc_broker_temp;
create table tommy_oto_ppc_broker_temp
select distinct broker_id from dw_db.dw_ajk_ppc_broker_daily_sd
where cal_dt >= DATE_SUB(CURDATE(),INTERVAL 7 day) and pm_prop>=1
and city_id= 11;


create index broker_id on tommy_oto_ppc_broker_temp(broker_id);


drop table if exists tommy_oto_coor_company_temp;
create table tommy_oto_coor_company_temp as
select distinct
       d.subregion_name,
       d.region_name,
       a.company_id,
       a.Stores_id,
       a.broker_id,
       case when e.broker_id is null then 0 else 1 end is_ppc
 from dw_db.dw_broker a
join dw_db.dw_nh_fx_company_user b on a.company_id = b.company_id
left join dw_db.dw_region_lkp d on a.subregion_id=d.subregion_id
left join tommy_oto_ppc_broker_temp e on a.broker_id = e.broker_id
where a.is_valid =1 and b.status = 1;


drop table if exists tommy_oto_coor_apply_temp;
create table tommy_oto_coor_apply_temp as
select fx_id,comm_id,count(distinct broker_id) broker_nbr
from dw_db.dw_nh_fx_apply
where status = 1
group by 1,2;


drop table if exists tommy_oto_coor_process_temp;
create table tommy_oto_coor_process_temp as
select fix_id,
       comm_id,
       count(distinct case when status1_dt!='1970-01-01' then broker_id end) broker_nbr1,
       count(distinct case when status2_dt!='1970-01-01' then broker_id end) broker_nbr2,
       count(distinct case when status3_dt!='1970-01-01' then broker_id end) broker_nbr3,
       count(distinct case when status4_dt!='1970-01-01' then broker_id end) broker_nbr4,
       count(case when status1_dt!='1970-01-01' then broker_id end) broker_nbr1_c,
       count(case when status2_dt!='1970-01-01' then broker_id end) broker_nbr2_c,
       count(case when status3_dt!='1970-01-01' then broker_id end) broker_nbr3_c,
       count(case when status4_dt!='1970-01-01' then broker_id end) broker_nbr4_c
 from dw_db.dw_nh_fx_customer
group by 1,2;




drop table if exists tommy_oto_coor_fianl_temp;
create table tommy_oto_coor_fianl_temp as
select log_dt,
       a.fx_id,
       d.comm_id,
       d.comm_name_nh,
       d.district_name region_name,
       d.block_name subregion_name,
       sum(b.broker_nbr) apply_broker_nbr,
       sum(c.broker_nbr1) order_broker_nbr,
       sum(c.broker_nbr2) see_broker_nbr,
       sum(c.broker_nbr3) swipe_broker_nbr,
       sum(c.broker_nbr4) deal_broker_nbr
from tommy_oto_coor_comm_temp a
join tommy_oto_coor_apply_temp b on a.fx_id = b.fx_id
join tommy_oto_coor_process_temp c on a.fx_id = c.fix_id
left join dw_db_test.tommy_msc_af_comm_extend_final d on a.comm_id = d.comm_id
group by 1,2,3,4;



drop table if exists tommy_oto_coor_fianl1;
create table tommy_oto_coor_fianl1 as
select a.log_dt,
       fx_id,
       comm_id,
       comm_name_nh,
       a.region_name,
       a.subregion_name,
       apply_broker_nbr,
       order_broker_nbr,
       see_broker_nbr,
       swipe_broker_nbr,
       deal_broker_nbr,
       count(distinct company_id) company_nbr,
       count(distinct broker_id) broker_nbr_total,
       count(distinct case when is_ppc=1 then broker_id end) ppc_broker_nbr_total,
       count(distinct case when a.region_name = b.region_name and is_ppc=1  then broker_id end) same_region_ppc_broker_nbr
from tommy_oto_coor_fianl_temp a,tommy_oto_coor_company_temp b
group by 1,2,3,4,5,6,7,8,9,10,11;

drop table if exists tommy_otp_billing_temp;
create table tommy_otp_billing_temp as
select fx_id,sum(amount) amount from  dw_db.dw_nh_fx_commission_billing
group by 1;


drop table if exists tommy_oto_coor_fianl2;
create table tommy_oto_coor_fianl2 as
select log_dt,
       a.fx_id,
       comm_id,
       comm_name_nh,
       company_nbr,
       broker_nbr_total,
       ppc_broker_nbr_total,
       same_region_ppc_broker_nbr,
       a.region_name,
       a.subregion_name,
       apply_broker_nbr,
       order_broker_nbr,
       see_broker_nbr,
       swipe_broker_nbr,
       deal_broker_nbr,
       b.amount
from tommy_oto_coor_fianl1 a
left join tommy_otp_billing_temp b on a.fx_id = b.fx_id;
        </div>
        <div style="padding: 10px;">
        <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-save'">保存</a>
        <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-redo'" style="margin-left: 10px;">运行</a>
        </div>
      </div>

      <div title="设计报表1" data-options="selected:true,tools:'#p-tools1'">

      <div style="margin: 10px;">
      子报表名称： <input type="text" value="分销每日数据 ${date}" class="mini-textbox">
      </div>

      <div style="margin: 10px; height: 400px;">
        <div class="easyui-tabs" data-options="fit:true,plain:true">
          <div title="查询语句" style="padding:10px;">
            <div id="sqlEditor" style="height: 100px;">
select log_dt, fx_id, comm_id, comm_name_nh
from tommy_oto_coor_fianl2
where log_dt between curdate() - interval 7 day and curdate()
            </div>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-redo'" style="margin-left: 10px;">运行</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-reload'" style="margin: 10px 0;">更新字段</a>

            <table class="easyui-datagrid" style="height: auto;" data-options="rownumbers:true,singleSelect:true">
            <thead>
              <tr>
                <th data-options="field:'log_dt'">log_dt</th>
                <th data-options="field:'fx_id'">fx_id</th>
                <th data-options="field:'comm_id'">comm_id</th>
                <th data-options="field:'comm_name_nh'">comm_name_nh</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2013-09-02</td>
                <td>2885</td>
                <td>241021</td>
                <td>远洋7号</td>
              </tr>
              <tr>
                <td>2013-09-03</td>
                <td>2885</td>
                <td>241021</td>
                <td>远洋7号</td>
              </tr>
              <tr>
                <td>2013-09-04</td>
                <td>2885</td>
                <td>241021</td>
                <td>远洋7号</td>
              </tr>
            </tbody>
            </table>

          </div>
          <div title="字段设计" style="padding:10px;" data-options="selected:true">

            <div class="easyui-layout" data-options="fit:true">

            <div data-options="region:'west',split:true" style="width:120px;">
              <ul class="field-list">
                <li><a href="#" style="background-color: silver;">log_dt</a></li>
                <li><a href="#">fx_id</a></li>
                <li><a href="#">comm_id</a></li>
                <li><a href="#">comm_name_nh</a></li>
              </ul>
            </div>

            <div data-options="region:'center'" style="padding: 5px">
            <table class="report-form">
              <tr>
                <th>显示名称：</th>
                <td><input type="text" value="日期" class="mini-textbox"></td>
              </tr>
              <tr>
                <th>格式化：</th>
                <td>
                  <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
                    <option>常规</option>
                    <option selected="selected">数值</option>
                    <option>百分比</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th>小数位数：</th>
                <td>
                  <input type="text" class="easyui-numberspinner" value="2" style="width: 40px;"></input>
                  <label>
                    <input type="checkbox" class="mini-checkbox"> 使用千分位符
                  </label>
                </td>
              </tr>
              <tr>
                <th>负数格式：</th>
                <td>
                  <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
                    <option>(1234.10)</option>
                    <option selected="selected">-1234.10</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th>对齐：</th>
                <td>
                  <label><input type="radio" name="alignment" checked="checked" class="mini-radio"> 居左</label>
                  <label><input type="radio" name="alignment" class="mini-radio"> 居中</label>
                  <label><input type="radio" name="alignment" class="mini-radio"> 居右</label>
                </td>
              </tr>
              <tr>
                <th class="align-top">高亮规则：</th>
                <td>
                  <div style="margin-bottom: 5px;">
                  <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
                    <option selected="selected">大于</option>
                    <option>等于</option>
                    <option>小于</option>
                  </select>
                  <input type="text" class="mini-textbox" value="100" style="width: 60px;">
                  &nbsp;&nbsp;格式：
                  <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
                    <option>粗体</option>
                    <option selected="selected">红色</option>
                    <option>绿色</option>
                  </select>
                  </div>
                  <div style="margin-bottom: 5px;">
                  <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
                    <option>大于</option>
                    <option>等于</option>
                    <option selected="selected">小于</option>
                  </select>
                  <input type="text" class="mini-textbox" value="20" style="width: 60px;">
                  &nbsp;&nbsp;格式：
                  <select class="easyui-combobox" data-options="editable:false,panelHeight:'auto'">
                    <option>粗体</option>
                    <option>红色</option>
                    <option selected="selected">绿色</option>
                  </select>
                  </div>
                </td>
              </tr>
            </table>
            </div>

            </div>
          </div>
          <div title="表格样式" style="padding:10px;">
            <img src="images/table-styles.png">
          </div>
          <div title="预览" style="padding: 10px; text-align: center;">
            <div style="font-size: 14px; font-weight: bold; margin-top: 10px;">每日分销数据 2013-09-04</div>
            <img src="images/table-preview.png">
          </div>
        </div>
      </div>

      </div>

      <div title="设计报表2" data-options="tools:'#p-tools2'"></div>
    </div>

    <div id="p-tools1">
        <a href="javascript:void(0)" class="icon-mini-add"></a>
    </div>
    <div id="p-tools2">
        <a href="javascript:void(0)" class="icon-mini-add"></a>
    </div>

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="js/ace/ace.js"></script>
    <script type="text/javascript">
        var editor = ace.edit('editor');
        editor.getSession().setMode('ace/mode/sql');

        var toolbar = [{
            text:'新增',
            iconCls:'icon-add',
        },{
            text:'删除',
            iconCls:'icon-cancel'
        }];

        var sqlEditor = ace.edit('sqlEditor');
        sqlEditor.getSession().setMode('ace/mode/sql');
    </script>
  </body>
</html>
